{{ define "styles" }}
<link rel="stylesheet" href="/styles/diary.css" />
{{ end }} {{ define "main" }}
<img src="/media/images/diary_header.png" />
<div class="header">
  <div class="left-header">
    <a href="/">vita nouva</a> / <strong><a href="/diary/">diary</a></strong>
  </div>
  <div class="right-header">"The Rose Garden by Carl Aagaard"</div>
</div>
<div class="content">
  {{/* Build sorted pages with org dates */}}
  {{ $sortedPages := slice }}
  {{ range .Pages }}
    {{ $date := partial "org-date.html" . }}
    {{ $sortedPages = $sortedPages | append (dict "page" . "date" $date) }}
  {{ end }}
  {{ $sortedPages = sort $sortedPages "date" "desc" }}
  
  {{/* Get page size from config, default to 20, 0 = no pagination */}}
  {{ $pageSize := site.Params.diaryPageSize | default 20 }}
  
  {{/* Apply pagination if page size > 0 */}}
  {{ $paginatedPages := $sortedPages }}
  {{ $paginator := false }}
  {{ if gt $pageSize 0 }}
    {{/* Hugo's paginator works with pages, so we extract page objects */}}
    {{ $pageObjects := slice }}
    {{ range $sortedPages }}
      {{ $pageObjects = $pageObjects | append .page }}
    {{ end }}
    {{ $paginator = .Paginate $pageObjects $pageSize }}
    {{/* Rebuild sorted slice for paginated pages only */}}
    {{ $paginatedPages = slice }}
    {{ range $paginator.Pages }}
      {{ $date := partial "org-date.html" . }}
      {{ $paginatedPages = $paginatedPages | append (dict "page" . "date" $date) }}
    {{ end }}
    {{ $paginatedPages = sort $paginatedPages "date" "desc" }}
  {{ end }}

  <!-- Diary Nav - only show dates for current page -->
  <nav>
    {{ range $paginatedPages }}
    <a href="/diary/#{{ .date.Format "02012006" }}">{{ .date.Format "02/01/2006" }}</a>
    {{ end }}
  </nav>
  
  <!-- Diary Entries -->
  <main>
    {{ range $index, $item := $paginatedPages }}
    {{ $page := $item.page }}
    {{ $date := $item.date }}
    <article
      id="{{ $date.Format "02012006" }}"
      {{ if eq $index (sub (len $paginatedPages) 1) }}
      style="border-bottom: none"
      {{ end }}
    >
      <div class="page-content">
        <div class="date">{{ $date.Format "02/01/2006" }}</div>
        <div class="page-writing">{{ partial "resolve-citations.html" (partial "resolve-roam-links.html" (partial "strip-org-title.html" $page.Content)) }}<a class="copy-permalink" data-url="{{ $page.Permalink }}" title="Copy permalink">[permlink]</a></div>
        {{ partial "native-backlinks.html" $page }}
      </div>
    </article>
    {{ end }}
    
    {{/* Pagination at bottom of main content */}}
    {{ if $paginator }}
      {{ partial "pagination.html" $paginator }}
    {{ end }}
  </main>
</div>
<div
  class="header"
  style="
    border-bottom: 0px;
    border-top: 1px dotted var(--darkbrown);
    position: sticky;
    bottom: 0px;
  "
>
  <div class="left-header"></div>
  <div class="right-header" style="padding-top: 5px">c. lr0 2025</div>
</div>
{{ end }} {{ define "scripts" }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const anchors = document.querySelectorAll("nav a:not(.copy-permalink)");
    const articles = document.querySelectorAll("article");
    const observerOptions = {
      root: null,
      rootMargin: "124px",
      threshold: 0.2,
    };
    const handleIntersection = (entries, observer) => {
      entries.forEach((entry) => {
        const anchor = document.querySelector(`a[href="#${entry.target.id}"]`);
        if (entry.isIntersecting && anchor) {
          anchors.forEach((a) => a.classList.remove("active"));
          anchor.classList.add("active");
        }
      });
    };
    const observer = new IntersectionObserver(
      handleIntersection,
      observerOptions,
    );
    articles.forEach((article) => observer.observe(article));

    // Copy permalink functionality
    document.querySelectorAll('.copy-permalink').forEach(el => {
      el.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = el.dataset.url;
        try {
          await navigator.clipboard.writeText(url);
          const original = el.textContent;
          el.textContent = '[copied]';
          setTimeout(() => el.textContent = original, 1500);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  });
</script>
{{ end }}
