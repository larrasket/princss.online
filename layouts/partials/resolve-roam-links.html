{{- $content := . -}}

{{- /* Build a map of org-roam ID -> URL from Hugo content only */ -}}
{{- $idMap := dict -}}
{{- range site.AllPages -}}
  {{- if and .File (eq .File.Ext "org") -}}
    {{- $rawContent := .RawContent -}}
    {{- $idMatch := findRE `:ID:\s+(\S+)` $rawContent 1 -}}
    {{- if $idMatch -}}
      {{- $idLine := index $idMatch 0 -}}
      {{- $id := replaceRE `:ID:\s+` "" $idLine -}}
      {{- $idMap = merge $idMap (dict $id .RelPermalink) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Replace id: links */ -}}
{{- $idLinkPattern := `<a href="id:([^"]+)"[^>]*>([^<]+)</a>` -}}
{{- $matches := findRE $idLinkPattern $content -}}
{{- range $matches -}}
  {{- $idMatch := findRE `id:([^"]+)` . 1 -}}
  {{- if $idMatch -}}
    {{- $fullId := index $idMatch 0 -}}
    {{- $id := replaceRE `id:` "" $fullId -}}
    {{- $textMatch := findRE `>([^<]+)</a>` . 1 -}}
    {{- $linkText := "" -}}
    {{- if $textMatch -}}
      {{- $linkText = replaceRE `>|</a>` "" (index $textMatch 0) -}}
    {{- end -}}
    {{- /* If ID found in Hugo content, make it a link */ -}}
    {{- if index $idMap $id -}}
      {{- $newHref := index $idMap $id -}}
      {{- $oldPattern := printf `href="id:%s"` $id -}}
      {{- $newPattern := printf `href="%s"` $newHref -}}
      {{- $content = replace $content $oldPattern $newPattern -}}
    {{- else -}}
      {{- /* ID not found - replace link with plain text */ -}}
      {{- $oldLink := . -}}
      {{- $content = replace $content $oldLink $linkText -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $content | safeHTML -}}
