{{- $content := . -}}

{{- /* Build a map of org-roam ID -> URL from Hugo content (ALL IDs, including sub-headings) */ -}}
{{- $idMap := dict -}}
{{- range site.AllPages -}}
  {{- if and .File (eq .File.Ext "org") -}}
    {{- $rawContent := .RawContent -}}
    {{- $baseUrl := .RelPermalink -}}
    {{- /* Extract ALL IDs from this page */ -}}
    {{- $idMatches := findRE `:ID:\s+(\S+)` $rawContent -}}
    {{- $customIdMatches := findRE `:CUSTOM_ID:\s+(\S+)` $rawContent -}}
    {{- /* First ID is the page-level ID (no anchor) */ -}}
    {{- $isFirst := true -}}
    {{- range $idMatches -}}
      {{- $id := replaceRE `:ID:\s+` "" . -}}
      {{- if $isFirst -}}
        {{- $idMap = merge $idMap (dict $id $baseUrl) -}}
        {{- $isFirst = false -}}
      {{- else -}}
        {{- /* Sub-heading: use ID as anchor */ -}}
        {{- $idMap = merge $idMap (dict $id (printf "%s#%s" $baseUrl $id)) -}}
      {{- end -}}
    {{- end -}}
    {{- /* Also map CUSTOM_IDs for anchor links */ -}}
    {{- range $customIdMatches -}}
      {{- $customId := replaceRE `:CUSTOM_ID:\s+` "" . -}}
      {{- $idMap = merge $idMap (dict $customId (printf "%s#%s" $baseUrl $customId)) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Replace id: links */ -}}
{{- $idLinkPattern := `<a href="id:([^"]+)"[^>]*>([^<]+)</a>` -}}
{{- $matches := findRE $idLinkPattern $content -}}
{{- range $matches -}}
  {{- $idMatch := findRE `id:([^"]+)` . 1 -}}
  {{- if $idMatch -}}
    {{- $fullId := index $idMatch 0 -}}
    {{- $id := replaceRE `id:` "" $fullId -}}
    {{- $textMatch := findRE `>([^<]+)</a>` . 1 -}}
    {{- $linkText := "" -}}
    {{- if $textMatch -}}
      {{- $linkText = replaceRE `>|</a>` "" (index $textMatch 0) -}}
    {{- end -}}
    {{- /* If ID found in Hugo content, make it a link */ -}}
    {{- if index $idMap $id -}}
      {{- $newHref := index $idMap $id -}}
      {{- $oldPattern := printf `href="id:%s"` $id -}}
      {{- $newPattern := printf `href="%s"` $newHref -}}
      {{- $content = replace $content $oldPattern $newPattern -}}
    {{- else -}}
      {{- /* ID not found - replace link with plain text */ -}}
      {{- $oldLink := . -}}
      {{- $content = replace $content $oldLink $linkText -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $content | safeHTML -}}
