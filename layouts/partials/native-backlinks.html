{{- /* Native backlinks partial - finds all pages that link to ANY ID in this page */}}
{{- /* Now supports sub-heading IDs and links with #anchor */}}

{{- /* Extract ALL IDs from this page (top-level and sub-headings) */}}
{{- $allIds := slice -}}
{{- $idMatches := findRE `:ID:\s+(\S+)` .RawContent -}}
{{- range $idMatches -}}
  {{- $id := replaceRE `:ID:\s+` "" . -}}
  {{- $allIds = $allIds | append $id -}}
{{- end -}}

{{- if $allIds -}}
  {{- /* Map of id -> anchor (using CUSTOM_ID if available) */}}
  {{- $idToAnchor := dict -}}
  {{- $customIdMatches := findRE `:CUSTOM_ID:\s+(\S+)` $.RawContent -}}
  {{- range $customIdMatches -}}
    {{- $customId := replaceRE `:CUSTOM_ID:\s+` "" . -}}
    {{- $idToAnchor = merge $idToAnchor (dict $customId $customId) -}}
  {{- end -}}
  
  {{- $backlinks := slice -}}
  {{- range site.AllPages -}}
    {{- if and .File (eq .File.Ext "org") -}}
      {{- if ne .RelPermalink $.RelPermalink -}}
        {{- $content := .RawContent -}}
        {{- $foundId := "" -}}
        {{- range $allIds -}}
          {{- if in $content . -}}
            {{- $foundId = . -}}
          {{- end -}}
        {{- end -}}
        {{- if $foundId -}}
          {{- $title := partial "org-title.html" . -}}
          {{- if $title -}}
            {{- /* Build URL with anchor if it's a sub-heading (not first ID) */}}
            {{- $url := .RelPermalink -}}
            {{- $anchor := index $idToAnchor $foundId -}}
            {{- if and $anchor (ne $foundId (index $allIds 0)) -}}
              {{- $url = printf "%s#%s" .RelPermalink $anchor -}}
            {{- end -}}
            {{- /* Check if already added (avoid duplicates) */}}
            {{- $exists := false -}}
            {{- range $backlinks -}}
              {{- if eq .title $title -}}
                {{- $exists = true -}}
              {{- end -}}
            {{- end -}}
            {{- if not $exists -}}
              {{- $backlinks = $backlinks | append (dict "url" $url "title" $title) -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- if $backlinks -}}
<div class="backlinks">
  <span class="backlinks-title">Referenced in: </span>
  {{- $total := len $backlinks -}}
  {{- range $i, $link := $backlinks -}}
    <a href="{{ $link.url }}">{{ $link.title }}</a>{{- if eq (add $i 2) $total }} and {{ else if lt (add $i 1) $total }}, {{ end -}}
  {{- end -}}
</div>
  {{- end -}}
{{- end -}}
